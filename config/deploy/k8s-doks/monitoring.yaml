# k8s-monitoring.yaml
# Complete monitoring stack for your Kubernetes cluster

---
# ConfigMap for Prometheus configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s

    rule_files:
      - "/etc/prometheus/alert_rules.yml"

    scrape_configs:
      - job_name: 'securities-api'
        static_configs:
          - targets: ['backend.demo.svc.cluster.local:5058']
        metrics_path: /metrics
        scrape_interval: 5s

      - job_name: 'prometheus'
        static_configs:
          - targets: ['localhost:9090']

  alert_rules.yml: |
    groups:
      - name: securities_api_alerts
        rules:
          - alert: HighErrorRate
            expr: sum(rate(securities_function_calls_total{status="error"}[5m])) / sum(rate(securities_function_calls_total[5m])) > 0.1
            for: 2m
            labels:
              severity: warning
            annotations:
              summary: "High error rate in securities API"
              description: "Error rate is {{ $value | humanizePercentage }} for the last 5 minutes"

          - alert: SlowResponseTime
            expr: histogram_quantile(0.95, sum(rate(securities_function_duration_seconds_bucket[5m])) by (le)) > 1.0
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "Slow response times in securities API"
              description: "95th percentile response time is {{ $value }}s"

---
# Prometheus Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: prometheus
spec:
  replicas: 1
  selector:
    matchLabels:
      app: prometheus
  template:
    metadata:
      labels:
        app: prometheus
    spec:
      containers:
        - name: prometheus
          image: prom/prometheus:latest
          ports:
            - containerPort: 9090
          args:
            - '--config.file=/etc/prometheus/prometheus.yml'
            - '--storage.tsdb.path=/prometheus'
            - '--web.console.libraries=/etc/prometheus/console_libraries'
            - '--web.console.templates=/etc/prometheus/consoles'
            - '--storage.tsdb.retention.time=15d'
            - '--web.enable-lifecycle'
          volumeMounts:
            - name: prometheus-config
              mountPath: /etc/prometheus
            - name: prometheus-storage
              mountPath: /prometheus
          resources:
            requests:
              memory: "400Mi"
              cpu: "100m"
            limits:
              memory: "800Mi"
              cpu: "500m"
      volumes:
        - name: prometheus-config
          configMap:
            name: prometheus-config
            items:
              - key: prometheus.yml
                path: prometheus.yml
              - key: alert_rules.yml
                path: alert_rules.yml
        - name: prometheus-storage
          emptyDir: {}

---
# Prometheus Service
apiVersion: v1
kind: Service
metadata:
  name: prometheus
spec:
  selector:
    app: prometheus
  ports:
    - port: 9090
      targetPort: 9090
  type: ClusterIP

---
# Grafana ConfigMap for datasources
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-datasources
data:
  datasources.yaml: |
    apiVersion: 1
    datasources:
      - name: Prometheus
        type: prometheus
        access: proxy
        url: http://prometheus:9090
        isDefault: true
        editable: true

---
# Grafana ConfigMap for dashboard providers
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-providers
data:
  dashboards.yaml: |
    apiVersion: 1
    providers:
      - name: 'securities-dashboards'
        orgId: 1
        folder: ''
        type: file
        disableDeletion: false
        updateIntervalSeconds: 10
        allowUiUpdates: true
        options:
          path: /var/lib/grafana/dashboards

---
# Grafana Dashboard ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-securities
data:
  securities-dashboard.json: |
    {
      "dashboard": {
        "id": null,
        "title": "Securities API Metrics",
        "tags": ["securities", "api", "performance"],
        "style": "dark",
        "timezone": "browser",
        "panels": [
          {
            "id": 1,
            "title": "Request Rate",
            "type": "stat",
            "targets": [
              {
                "expr": "sum(rate(securities_function_calls_total[5m]))",
                "refId": "A"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "reqps",
                "color": { "mode": "thresholds" },
                "thresholds": {
                  "steps": [
                    { "color": "green", "value": null },
                    { "color": "yellow", "value": 10 },
                    { "color": "red", "value": 50 }
                  ]
                }
              }
            },
            "gridPos": { "h": 8, "w": 6, "x": 0, "y": 0 }
          },
          {
            "id": 2,
            "title": "Success Rate",
            "type": "stat",
            "targets": [
              {
                "expr": "sum(rate(securities_function_calls_total{status=\"success\"}[5m])) / sum(rate(securities_function_calls_total[5m])) * 100",
                "refId": "A"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "percent",
                "color": { "mode": "thresholds" },
                "thresholds": {
                  "steps": [
                    { "color": "red", "value": null },
                    { "color": "yellow", "value": 95 },
                    { "color": "green", "value": 99 }
                  ]
                }
              }
            },
            "gridPos": { "h": 8, "w": 6, "x": 6, "y": 0 }
          },
          {
            "id": 3,
            "title": "Response Time (95th percentile)",
            "type": "stat",
            "targets": [
              {
                "expr": "histogram_quantile(0.95, sum(rate(securities_function_duration_seconds_bucket[5m])) by (le))",
                "refId": "A"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "s",
                "color": { "mode": "thresholds" },
                "thresholds": {
                  "steps": [
                    { "color": "green", "value": null },
                    { "color": "yellow", "value": 0.1 },
                    { "color": "red", "value": 0.5 }
                  ]
                }
              }
            },
            "gridPos": { "h": 8, "w": 6, "x": 12, "y": 0 }
          },
          {
            "id": 4,
            "title": "Database Query Performance",
            "type": "graph",
            "targets": [
              {
                "expr": "histogram_quantile(0.50, sum(rate(securities_db_query_duration_seconds_bucket[5m])) by (le))",
                "refId": "A",
                "legendFormat": "50th percentile"
              },
              {
                "expr": "histogram_quantile(0.95, sum(rate(securities_db_query_duration_seconds_bucket[5m])) by (le))",
                "refId": "B",
                "legendFormat": "95th percentile"
              }
            ],
            "yAxes": [{ "label": "Seconds", "show": true }],
            "gridPos": { "h": 9, "w": 12, "x": 0, "y": 8 }
          }
        ],
        "time": { "from": "now-1h", "to": "now" },
        "refresh": "5s"
      }
    }

---
# Grafana Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: grafana
spec:
  replicas: 1
  selector:
    matchLabels:
      app: grafana
  template:
    metadata:
      labels:
        app: grafana
    spec:
      containers:
        - name: grafana
          image: grafana/grafana:latest
          ports:
            - containerPort: 3000
          env:
            - name: GF_SECURITY_ADMIN_USER
              value: admin
            - name: GF_SECURITY_ADMIN_PASSWORD
              value: admin123  # ‚ö†Ô∏è Use a Secret in production
            - name: GF_USERS_ALLOW_SIGN_UP
              value: "false"
          volumeMounts:
            - name: grafana-storage
              mountPath: /var/lib/grafana
            - name: grafana-datasources
              mountPath: /etc/grafana/provisioning/datasources
            - name: grafana-dashboard-providers
              mountPath: /etc/grafana/provisioning/dashboards
            - name: grafana-dashboard-securities
              mountPath: /var/lib/grafana/dashboards
          resources:
            requests:
              memory: "200Mi"
              cpu: "100m"
            limits:
              memory: "400Mi"
              cpu: "200m"
      volumes:
        - name: grafana-storage
          emptyDir: {}
        - name: grafana-datasources
          configMap:
            name: grafana-datasources
        - name: grafana-dashboard-providers
          configMap:
            name: grafana-dashboard-providers
        - name: grafana-dashboard-securities
          configMap:
            name: grafana-dashboard-securities

---
# Grafana Service
apiVersion: v1
kind: Service
metadata:
  name: grafana
spec:
  selector:
    app: grafana
  ports:
    - port: 3000
      targetPort: 3000
  type: ClusterIP

---
# Optional: Ingress for Grafana
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: grafana-ingress
  annotations:
    kubernetes.io/ingress.class: "nginx"
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
spec:
  ingressClassName: nginx
  rules:
    - host: grafana.demo.atlantis.trading  # üîß Update this for your environment
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: grafana
                port:
                  number: 3000
