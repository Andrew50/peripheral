apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: app-ingress
  annotations:
    # Timeouts - Increased for chat responses
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "1200"  # Increased from 600 to 1200
    nginx.ingress.kubernetes.io/proxy-read-timeout: "1200"  # Increased from 600 to 1200
    nginx.ingress.kubernetes.io/send-timeout: "1200"        # Increased from 600 to 1200

    # Increase body size for large uploads
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"

    # Buffers - Significantly increased for large chat responses
    nginx.ingress.kubernetes.io/proxy-buffer-size: "1m"     # Increased from 256k to 1MB
    nginx.ingress.kubernetes.io/proxy-buffers-number: "16"  # Increased from 8 to 16
    nginx.ingress.kubernetes.io/proxy-busy-buffers-size: "2m" # Increased from 512k to 2MB

    # Header preservation for webhooks (especially Stripe-Signature)
    nginx.ingress.kubernetes.io/configuration-snippet: |
      more_set_headers "X-Forwarded-Proto: https";
      proxy_set_header Stripe-Signature $http_stripe_signature;
      proxy_pass_header Stripe-Signature;
    
    # Preserve all headers and ensure webhook compatibility
    nginx.ingress.kubernetes.io/proxy-pass-headers: "Stripe-Signature,X-Stripe-*"
    nginx.ingress.kubernetes.io/upstream-hash-by: "$request_uri"

    # SSL redirect off (since Cloudflare is terminating SSL)
    nginx.ingress.kubernetes.io/ssl-redirect: "false"

spec:
  ingressClassName: nginx
  rules:
    - host: ${INGRESS_HOST}
      http:
        paths:
          - path: /private
            pathType: Prefix
            backend:
              service:
                name: backend
                port:
                  number: 5058
          - path: /public
            pathType: Prefix
            backend:
              service:
                name: backend
                port:
                  number: 5058
          - path: /upload
            pathType: Prefix
            backend:
              service:
                name: backend
                port:
                  number: 5058
          - path: /billing/webhook
            pathType: Prefix
            backend:
              service:
                name: backend
                port:
                  number: 5058
          - path: /
            pathType: Prefix
            backend:
              service:
                name: frontend
                port:
                  number: 80
    - host: www.${INGRESS_HOST}
      http:
        paths:
          - path: /private
            pathType: Prefix
            backend:
              service:
                name: backend
                port:
                  number: 5058
          - path: /public
            pathType: Prefix
            backend:
              service:
                name: backend
                port:
                  number: 5058
          - path: /upload
            pathType: Prefix
            backend:
              service:
                name: backend
                port:
                  number: 5058
          - path: /billing/webhook
            pathType: Prefix
            backend:
              service:
                name: backend
                port:
                  number: 5058
          - path: /
            pathType: Prefix
            backend:
              service:
                name: frontend
                port:
                  number: 80

---
# Separate WebSocket-optimized ingress for better performance
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: websocket-ingress
  annotations:
    # WebSocket optimized timeouts
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"     # 1 hour for long-running connections
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"     # 1 hour for long-running connections
    nginx.ingress.kubernetes.io/send-timeout: "3600"
    
    # WebSocket specific settings
    nginx.ingress.kubernetes.io/enable-websocket: "true"
    nginx.ingress.kubernetes.io/proxy-http-version: "1.1"
    nginx.ingress.kubernetes.io/websocket-timeout: "3600"
    
    # Disable buffering for real-time communication
    nginx.ingress.kubernetes.io/proxy-buffering: "off"
    nginx.ingress.kubernetes.io/proxy-request-buffering: "off"
    
    # Connection optimization
    nginx.ingress.kubernetes.io/upstream-keepalive-connections: "1000"
    nginx.ingress.kubernetes.io/upstream-keepalive-timeout: "3600"
    
    # SSL redirect off
    nginx.ingress.kubernetes.io/ssl-redirect: "false"

spec:
  ingressClassName: nginx
  rules:
    - host: ${INGRESS_HOST}
      http:
        paths:
          - path: /ws
            pathType: Prefix
            backend:
              service:
                name: backend
                port:
                  number: 5058
    - host: www.${INGRESS_HOST}
      http:
        paths:
          - path: /ws
            pathType: Prefix
            backend:
              service:
                name: backend
                port:
                  number: 5058
