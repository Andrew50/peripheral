name: Format and Lint

on:
  push:
    paths:
      - '**/*.go'
      - '**/*.py'
      - '**/*.sql'
      - '**/*.{js,ts,svelte,css}'
      - '**/*.yml'
      - '**/*.yaml'
  pull_request:
    paths:
      - '**/*.go'
      - '**/*.py'
      - '**/*.sql'
      - '**/*.{js,ts,svelte,css}'
      - '**/*.yml'
      - '**/*.yaml'
  workflow_dispatch:

env:
  # Linting configuration
  GOLANGCI_LINT_VERSION: v2.1.0
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  # Go Linting with golangci-lint (camelCase enforcement)
  lint-go:
    name: Go Lint (camelCase enforcement)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ðŸ”§ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ¹ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: stable
          cache: true
          cache-dependency-path: services/backend/go.sum

      - name: ðŸ“¦ Install golangci-lint
        uses: golangci/golangci-lint-action@v8
        with:
          version: ${{ env.GOLANGCI_LINT_VERSION }}
          args: run --timeout 5m --config .golangci.yml

      - name: ðŸ” Run golangci-lint (check only)
        run: |
          echo "ðŸ” Running Go linting with camelCase enforcement (check only)..."
          golangci-lint run --timeout 5m --config .golangci.yml ./services/backend/... --no-fix

  # Python Linting with Pylint (camelCase enforcement)
  lint-python:
    name: Python Lint (camelCase enforcement)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ðŸ”§ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: services/worker/requirements.txt

      - name: ðŸ“¦ Install Python dependencies
        run: |
          cd services/worker
          pip install -r requirements.txt
          cd ../..

      - name: ðŸ”§ Generate Pylint configuration for camelCase
        run: |
          echo "ðŸ”§ Generating Pylint configuration for camelCase enforcement..."
          cat > .pylintrc.camelcase << 'EOF'
          [MASTER]
          ignore=tests,__pycache__,.git
          disable=C0111,C0103

          [NAMING]
          variable-naming-style=camelCase
          function-naming-style=camelCase
          argument-naming-style=camelCase
          attr-naming-style=camelCase
          method-naming-style=camelCase
          class-naming-style=PascalCase
          const-naming-style=camelCase
          module-naming-style=camelCase

          [FORMAT]
          max-line-length=120

          [MESSAGES CONTROL]
          disable=C0114,C0115,C0116
          EOF

      - name: ðŸ” Run Pylint with camelCase enforcement (check only)
        run: |
          echo "ðŸ” Running Python linting with camelCase enforcement (check only)..."
          pylint services/worker/ --rcfile=.pylintrc.camelcase --output-format=text --exit-zero

  # Svelte/TypeScript/JavaScript Linting (camelCase enforcement)
  lint-svelte:
    name: Svelte/TS/JS Lint (camelCase enforcement)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ðŸ”§ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: services/frontend/package-lock.json

      - name: ðŸ“¦ Install dependencies
        run: |
          echo "ðŸ“¦ Installing Node.js dependencies..."
          cd services/frontend
          npm ci
          npm install --save-dev stylelint stylelint-config-standard
          cd ../..

      - name: ðŸ”§ Generate ESLint configuration for camelCase enforcement
        run: |
          echo "ðŸ”§ Generating ESLint configuration for camelCase enforcement..."
          cat > .eslintrc.camelcase.js << 'EOF'
          import js from '@eslint/js';
          import ts from 'typescript-eslint';
          import svelte from 'eslint-plugin-svelte';
          import prettier from 'eslint-config-prettier';
          import globals from 'globals';

          /** @type {import('eslint').Linter.Config[]} */
          export default [
            js.configs.recommended,
            ...ts.configs.recommended,
            ...svelte.configs['flat/recommended'],
            prettier,
            ...svelte.configs['flat/prettier'],
            {
              languageOptions: {
                globals: {
                  ...globals.browser,
                  ...globals.node
                }
              }
            },
            {
              files: ['**/*.svelte'],
              languageOptions: {
                parserOptions: {
                  parser: ts.parser
                }
              }
            },
            {
              ignores: [
                'build/',
                '.svelte-kit/',
                'dist/',
                'node_modules/',
                'vite.config.ts.timestamp-*',
                '**/*.min.js'
              ]
            },
            // CamelCase enforcement rules
            {
              rules: {
                // Enforce camelCase for all identifiers
                camelcase: ['error', { properties: 'always' }],
                '@typescript-eslint/naming-convention': [
                  'error',
                  { selector: 'default', format: ['camelCase'], leadingUnderscore: 'forbid', trailingUnderscore: 'forbid' },
                  { selector: 'variableLike', format: ['camelCase'], leadingUnderscore: 'forbid', trailingUnderscore: 'forbid' },
                  { selector: 'typeLike', format: ['PascalCase'] },
                  { selector: 'enumMember', format: ['PascalCase'] },
                  { selector: 'parameter', format: ['camelCase'], leadingUnderscore: 'allow' },
                  { selector: 'memberLike', modifiers: ['private'], format: ['camelCase'], leadingUnderscore: 'require' }
                ],
                // Additional rules for code quality
                'no-unused-vars': 'off',
                '@typescript-eslint/no-unused-vars': ['error', { argsIgnorePattern: '^_' }],
                'prefer-const': 'error',
                'no-var': 'error',
                // Disable some rules that might conflict with existing code
                '@typescript-eslint/no-explicit-any': 'off',
                '@typescript-eslint/no-unused-expressions': 'off',
                '@typescript-eslint/no-unsafe-function-type': 'off',
                'no-undef': 'off',
                'svelte/valid-compile': 'off',
                'svelte/no-at-html-tags': 'off',
                'no-empty': 'off',
                'no-import-assign': 'off'
              }
            }
          ];
          EOF

      - name: ðŸ” Run ESLint with camelCase enforcement (check only)
        run: |
          echo "ðŸ” Running ESLint with camelCase enforcement (check only)..."
          cd services/frontend
          npx eslint 'src/**/*.{js,ts,svelte}' --config ../../.eslintrc.camelcase.js

      - name: ðŸŽ¨ Run Stylelint with camelCase enforcement (check only)
        run: |
          echo "ðŸŽ¨ Running Stylelint with camelCase enforcement (check only)..."
          cd services/frontend
          npx stylelint 'src/**/*.{css,svelte}' --config ../../.stylelintrc.json --no-fix

  # YAML/JSON Formatting
  format-yaml:
    name: YAML/JSON Format
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: ðŸ”§ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ðŸ“¦ Install YAML tools
        run: |
          echo "ðŸ“¦ Installing YAML formatting tools..."
          pip install yamllint pyyaml

      - name: ðŸ”§ Generate YAML lint configuration
        run: |
          echo "ðŸ”§ Generating YAML lint configuration..."
          cat > .yamllint << 'EOF'
          extends: default

          rules:
            line-length:
              max: 120
            document-start: disable
            trailing-spaces: enable
            truthy:
              check-keys: false
          EOF

      - name: ðŸ” Run YAML lint (check only)
        run: |
          echo "ðŸ” Running YAML linting (check only)..."
          yamllint -c .yamllint .github/ config/ services/ --strict

  # Summary and reporting
  lint-summary:
    name: Lint Summary
    runs-on: ubuntu-latest
    needs: [lint-go, lint-python, lint-svelte, format-yaml]
    if: always()
    
    steps:
      - name: ðŸ“Š Generate Lint Summary
        run: |
          echo "ðŸ“Š Format and Lint Summary Report"
          echo "================================"
          echo ""
          echo "âœ… Go linting completed with camelCase enforcement"
          echo "âœ… Python linting completed with camelCase enforcement"
          echo "âœ… Svelte/TS/JS linting completed with camelCase enforcement"
          echo "âœ… YAML/JSON formatting completed"
          echo ""
          echo "ðŸŽ¯ All linting checks enforce camelCase naming conventions"
          echo "ðŸš« snake_case is not allowed in any language"
          echo "ðŸ“‹ All linters run in CHECK-ONLY mode - no code modifications"
          echo ""
          echo "ðŸ“‹ Summary:"
          echo "- Go: golangci-lint with revive rules for camelCase"
          echo "- Python: Pylint with camelCase naming rules"
          echo "- Svelte/TS/JS: ESLint (flat config) + Stylelint with camelCase rules"
          echo "- YAML: yamllint for formatting consistency" 