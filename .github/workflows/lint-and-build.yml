name: Lint and Build Check
on:
  pull_request:
    branches: [main, prod]
  
  # Add push trigger for specific branches
  push:
    branches: [ben, aj]
  
  # Add workflow_run trigger to run after branch-protection workflow
  workflow_run:
    workflows: ["Branch Protection Check"]
    types:
      - completed

jobs:
  # Add a check to determine if we should run the tests
  check-workflow-conditions:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      continue_on_error: ${{ steps.check.outputs.continue_on_error }}
    steps:
      - id: check
        run: |
          # For pushes to ben or aj branches, run but don't fail on errors
          if [[ "${{ github.event_name }}" == "push" && ("${{ github.ref }}" == "refs/heads/ben" || "${{ github.ref }}" == "refs/heads/aj") ]]; then
            echo "Running for push to ben/aj branch - will not fail on errors"
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "continue_on_error=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # For direct PRs to main, always run
          if [[ "${{ github.event_name }}" == "pull_request" && "${{ github.base_ref }}" == "main" ]]; then
            echo "Running for PR to main branch"
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "continue_on_error=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # For PRs to prod, only run if triggered by workflow_run and the previous workflow succeeded
          if [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            if [[ "${{ github.event.workflow_run.conclusion }}" == "success" ]]; then
              echo "Branch protection check passed, proceeding with tests"
              echo "should_run=true" >> $GITHUB_OUTPUT
              echo "continue_on_error=false" >> $GITHUB_OUTPUT
            else
              echo "Branch protection check did not pass, skipping tests"
              echo "should_run=false" >> $GITHUB_OUTPUT
              echo "continue_on_error=false" >> $GITHUB_OUTPUT
            fi
            exit 0
          fi
          
          # For direct PRs to prod, don't run (branch protection should run first)
          if [[ "${{ github.event_name }}" == "pull_request" && "${{ github.base_ref }}" == "prod" ]]; then
            echo "Skipping direct run for PR to prod - branch protection workflow should run first"
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "continue_on_error=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Default case
          echo "Running tests by default"
          echo "should_run=true" >> $GITHUB_OUTPUT
          echo "continue_on_error=false" >> $GITHUB_OUTPUT

  lint-and-build-backend:
    needs: check-workflow-conditions
    if: needs.check-workflow-conditions.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    # Set continue-on-error based on the branch condition
    continue-on-error: ${{ needs.check-workflow-conditions.outputs.continue_on_error == 'true' }}
    # Add permissions block for annotations
    permissions:
      contents: read
      checks: write
      pull-requests: read
    steps:
      - uses: actions/checkout@v3
        with:
          # For workflow_run events, we need to check out the PR that triggered the workflow
          ref: ${{ github.event.workflow_run.head_branch || github.ref }}

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.24'
          cache: true
      
      - name: Install dependencies
        run: |
          cd services/backend
          go mod download
          go install honnef.co/go/tools/cmd/staticcheck@latest

      - name: Go Lint
        uses: golangci/golangci-lint-action@v3
        with:
          version: latest
          working-directory: services/backend
          args: --timeout=5m --config=.golangci.yml --out-format=colored-line-number --max-issues-per-linter=10 --max-same-issues=5 --build-tags=all
          skip-cache: true
          skip-pkg-cache: true
          skip-build-cache: true
          only-new-issues: true
        # Individual step can continue on error for ben/aj branches
        continue-on-error: ${{ needs.check-workflow-conditions.outputs.continue_on_error == 'true' }}

      - name: Go Staticcheck
        run: |
          cd services/backend
          # Run staticcheck with less strict settings
          # First run to print all issues
          staticcheck -tags=all -checks=all,-ST1000,-ST1003,-ST1016 ./... || true
          # Second run to actually fail the build only on critical issues
          staticcheck -tags=all -checks=all,-ST1000,-ST1003,-ST1016,-SA4006,-SA5000,-SA6000 ./...
        # Individual step can continue on error for ben/aj branches
        continue-on-error: ${{ needs.check-workflow-conditions.outputs.continue_on_error == 'true' }}

      - name: Go Build
        run: |
          cd services/backend
          go build -v -tags=all ./...
        # Individual step can continue on error for ben/aj branches
        continue-on-error: ${{ needs.check-workflow-conditions.outputs.continue_on_error == 'true' }}

  lint-and-build-worker:
    needs: check-workflow-conditions
    if: needs.check-workflow-conditions.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    # Set continue-on-error based on the branch condition
    continue-on-error: ${{ needs.check-workflow-conditions.outputs.continue_on_error == 'true' }}
    steps:
      - uses: actions/checkout@v3
        with:
          # For workflow_run events, we need to check out the PR that triggered the workflow
          ref: ${{ github.event.workflow_run.head_branch || github.ref }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          cd services/worker
          python -m pip install --upgrade pip
          pip install flake8 black pytest
          pip install -r requirements.txt

      - name: Lint with flake8
        run: |
          cd services/worker
          
          flake8 . \
            --count \
            --select=C901,E9,E711,E722,F7,F82,F401,F541,F811,F841 \
            --show-source \
            --statistics
        continue-on-error: ${{ needs.check-workflow-conditions.outputs.continue_on_error == 'true' }}

      - name: Format check with Black
        run: |
          cd services/worker
          black --check --diff --verbose . || echo "Black formatting issues found but continuing"
        # Always continue even if Black finds issues
        continue-on-error: true

      - name: Basic import check
        run: |
          cd services/worker
          python -m compileall .
        # Individual step can continue on error for ben/aj branches
        continue-on-error: ${{ needs.check-workflow-conditions.outputs.continue_on_error == 'true' }}

  lint-and-build-frontend:
    needs: check-workflow-conditions
    if: needs.check-workflow-conditions.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    # Set continue-on-error based on the branch condition
    continue-on-error: ${{ needs.check-workflow-conditions.outputs.continue_on_error == 'true' }}
    steps:
      - uses: actions/checkout@v3
        with:
          # For workflow_run events, we need to check out the PR that triggered the workflow
          ref: ${{ github.event.workflow_run.head_branch || github.ref }}

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: services/frontend/package.json

      - name: Install dependencies
        run: |
          cd services/frontend
          npm install
          # Install test runner dependencies with specific versions that support ES modules
          npm install --save-dev jest@29 @types/jest ts-jest@29 svelte-jester@2 @testing-library/svelte @testing-library/jest-dom jsdom
          
          # Create Jest config if it doesn't exist
          if [ ! -f jest.config.js ]; then
            echo "Creating Jest configuration file..."
            echo 'export default {' > jest.config.js
            echo '  transform: {' >> jest.config.js
            echo '    "^.+\\.svelte$": "svelte-jester",' >> jest.config.js
            echo '    "^.+\\.ts$": "ts-jest"' >> jest.config.js
            echo '  },' >> jest.config.js
            echo '  moduleFileExtensions: ["js", "ts", "svelte"],' >> jest.config.js
            echo '  testEnvironment: "jsdom",' >> jest.config.js
            echo '  setupFilesAfterEnv: ["@testing-library/jest-dom/extend-expect"],' >> jest.config.js
            echo '  testMatch: ["**/*.test.ts", "**/*.test.js"],' >> jest.config.js
            echo '  moduleNameMapper: {' >> jest.config.js
            echo '    "^\\$lib/(.*)$": "<rootDir>/src/lib/$1"' >> jest.config.js
            echo '  },' >> jest.config.js
            echo '  extensionsToTreatAsEsm: [".ts", ".svelte"],' >> jest.config.js
            echo '  globals: {' >> jest.config.js
            echo '    "ts-jest": {' >> jest.config.js
            echo '      useESM: true' >> jest.config.js
            echo '    }' >> jest.config.js
            echo '  }' >> jest.config.js
            echo '};' >> jest.config.js
          fi

      - name: Lint
        run: |
          cd services/frontend
          # Allow some warnings but still fail on errors
          npx eslint . --max-warnings=20 --no-error-on-unmatched-pattern --format stylish
        # Individual step can continue on error for ben/aj branches
        continue-on-error: ${{ needs.check-workflow-conditions.outputs.continue_on_error == 'true' }}

      - name: Type check
        run: |
          cd services/frontend
          # Change to error threshold to be more lenient
          npx svelte-check --threshold error --diagnostic-sources "js,ts,svelte"
        # Individual step can continue on error for ben/aj branches
        continue-on-error: ${{ needs.check-workflow-conditions.outputs.continue_on_error == 'true' }}

      - name: Build
        run: |
          cd services/frontend
          npm run build
        # Individual step can continue on error for ben/aj branches
        continue-on-error: ${{ needs.check-workflow-conditions.outputs.continue_on_error == 'true' }}

  # Add new job to run frontend tests
  test-frontend:
    needs: [check-workflow-conditions, lint-and-build-frontend]
    if: needs.check-workflow-conditions.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    # Set continue-on-error based on the branch condition
    continue-on-error: ${{ needs.check-workflow-conditions.outputs.continue_on_error == 'true' }}
    steps:
      - uses: actions/checkout@v3
        with:
          # For workflow_run events, we need to check out the PR that triggered the workflow
          ref: ${{ github.event.workflow_run.head_branch || github.ref }}

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: services/frontend/package.json

      - name: Install dependencies
        run: |
          cd services/frontend
          npm install
          # Install test runner dependencies with specific versions that support ES modules
          npm install --save-dev jest@29 @types/jest ts-jest@29 svelte-jester@2 @testing-library/svelte @testing-library/jest-dom jsdom
          
          # Create Jest config if it doesn't exist
          if [ ! -f jest.config.js ]; then
            echo "Creating Jest configuration file..."
            echo 'export default {' > jest.config.js
            echo '  transform: {' >> jest.config.js
            echo '    "^.+\\.svelte$": "svelte-jester",' >> jest.config.js
            echo '    "^.+\\.ts$": "ts-jest"' >> jest.config.js
            echo '  },' >> jest.config.js
            echo '  moduleFileExtensions: ["js", "ts", "svelte"],' >> jest.config.js
            echo '  testEnvironment: "jsdom",' >> jest.config.js
            echo '  setupFilesAfterEnv: ["@testing-library/jest-dom/extend-expect"],' >> jest.config.js
            echo '  testMatch: ["**/*.test.ts", "**/*.test.js"],' >> jest.config.js
            echo '  moduleNameMapper: {' >> jest.config.js
            echo '    "^\\$lib/(.*)$": "<rootDir>/src/lib/$1"' >> jest.config.js
            echo '  },' >> jest.config.js
            echo '  extensionsToTreatAsEsm: [".ts", ".svelte"],' >> jest.config.js
            echo '  globals: {' >> jest.config.js
            echo '    "ts-jest": {' >> jest.config.js
            echo '      useESM: true' >> jest.config.js
            echo '    }' >> jest.config.js
            echo '  }' >> jest.config.js
            echo '};' >> jest.config.js
          fi

      - name: Run tests
        run: |
          cd services/frontend
          # Run tests using the npm script that handles ES modules
          npm test
        # Individual step can continue on error for ben/aj branches
        continue-on-error: ${{ needs.check-workflow-conditions.outputs.continue_on_error == 'true' }} 