name: Deploy to Production

on:
  push:
    branches:
      - prod  # Trigger on pushes to the prod branch
  pull_request:
    branches:
      - prod  # Trigger on pull requests to the prod branch

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # Print debug info about secrets (masked in logs)
      - name: Debug secrets
        run: |
          echo "Checking if REMOTE_HOST secret exists: ${{ secrets.REMOTE_HOST != '' }}"
          echo "Checking if REMOTE_USER secret exists: ${{ secrets.REMOTE_USER != '' }}"
          echo "Checking if SSH_PRIVATE_KEY secret exists: ${{ secrets.SSH_PRIVATE_KEY != '' }}"

      # Set up SSH key
      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.REMOTE_HOST }} >> ~/.ssh/known_hosts

      # Deploy using direct SSH command
      - name: Deploy to production server
        run: |
          ssh -v ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_HOST }} << 'EOF'
            cd /home/aj/dev/study
            git checkout prod
            git pull origin prod
            
            # Set up environment for Docker login
            echo "Attempting Docker login on remote server..."
            
            # Login to Docker Hub with verbose output
            echo "Running Docker login command..."
            docker login docker.io -u "${{ secrets.DOCKERHUB_USERNAME }}" -p "${{ secrets.DOCKERHUB_TOKEN }}" || {
              echo "Docker login failed with exit code $?"
              echo "Docker login error details:"
              docker info
              exit 1
            }
            echo "Docker login successful!"
            
            # Build and push images directly on the server
            echo "Building and pushing Docker images..."
            
            # Backend
            echo "Building backend image..."
            docker build -t "${{ secrets.DOCKERHUB_USERNAME }}/backend:latest" -f ./backend/Dockerfile.prod ./backend
            echo "Pushing backend image..."
            docker push "${{ secrets.DOCKERHUB_USERNAME }}/backend:latest"
            
            # Frontend
            echo "Building frontend image..."
            docker build -t "${{ secrets.DOCKERHUB_USERNAME }}/frontend:latest" -f ./frontend/Dockerfile.prod ./frontend
            echo "Pushing frontend image..."
            docker push "${{ secrets.DOCKERHUB_USERNAME }}/frontend:latest"
            
            # Database
            echo "Building database image..."
            docker build -t "${{ secrets.DOCKERHUB_USERNAME }}/db:latest" -f ./db/Dockerfile.prod ./db
            echo "Pushing database image..."
            docker push "${{ secrets.DOCKERHUB_USERNAME }}/db:latest"
            
            # Worker
            echo "Building worker image..."
            docker build -t "${{ secrets.DOCKERHUB_USERNAME }}/worker:latest" -f ./worker/Dockerfile ./worker
            echo "Pushing worker image..."
            docker push "${{ secrets.DOCKERHUB_USERNAME }}/worker:latest"
            
            # TF
            echo "Building tf image..."
            docker build -t "${{ secrets.DOCKERHUB_USERNAME }}/tf:latest" -f ./tf/Dockerfile ./tf
            echo "Pushing tf image..."
            docker push "${{ secrets.DOCKERHUB_USERNAME }}/tf:latest"
            
            # Cache
            echo "Building cache image..."
            docker build -t "${{ secrets.DOCKERHUB_USERNAME }}/cache:latest" -f ./cache/Dockerfile ./cache
            echo "Pushing cache image..."
            docker push "${{ secrets.DOCKERHUB_USERNAME }}/cache:latest"
            
            # Nginx
            echo "Building nginx image..."
            docker build -t "${{ secrets.DOCKERHUB_USERNAME }}/nginx:latest" -f ./nginx/Dockerfile ./nginx
            echo "Pushing nginx image..."
            docker push "${{ secrets.DOCKERHUB_USERNAME }}/nginx:latest"
            
            # Apply Kubernetes configurations
            echo "Applying Kubernetes configurations..."
            cd prod
            kubectl apply -f config/
            
            # Perform rolling updates
            echo "Performing rolling updates..."
            kubectl rollout restart deployment/backend
            kubectl rollout restart deployment/frontend
            kubectl rollout restart deployment/worker
            kubectl rollout restart deployment/tf
            kubectl rollout restart deployment/db
            kubectl rollout restart deployment/cache
            kubectl rollout restart deployment/nginx
          EOF 