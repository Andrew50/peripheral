name: Deploy to Kubernetes (Production)

on:
  push:
    branches:
      - prod
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy'
        required: false

permissions:
  contents: read
  packages: write
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  deploy-prod:
    uses: ./.github/workflows/deploy.yml
    with:
      environment: 'prod'
      target_branch: ${{ github.event.inputs.branch || github.ref_name }}
      # k8s_context: 'prod-cluster'
      k8s_namespace: 'prod'
      google_redirect_url: 'https://peripheral.io/auth/google/callback'
      ingress_host: 'peripheral.io'
      #      public_base_url: 'https://peripheral.io'
    secrets:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_TOKEN: ${{ secrets.DOCKER_TOKEN }}
      DB_ROOT_PASSWORD: ${{ secrets.DB_ROOT_PASSWORD }}
      REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
      POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
      POLYGON_S3_KEY: ${{ secrets.POLYGON_S3_KEY }}
      POLYGON_S3_SECRET: ${{ secrets.POLYGON_S3_SECRET }}
      GEMINI_FREE_KEYS: ${{ secrets.GEMINI_FREE_KEYS }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
      GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      CLOUDFLARE_TUNNEL_TOKEN: ${{ secrets.CLOUDFLARE_TOKEN }}
      TELEGRAM_BOT_TOKEN_B64: ${{ secrets.TELEGRAM_BOT_TOKEN_B64 }}
      TELEGRAM_CHAT_ID_B64: ${{ secrets.TELEGRAM_CHAT_ID_B64 }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
      X_API_KEY: ${{ secrets.X_API_KEY }}
      X_API_SECRET: ${{ secrets.X_API_SECRET }}
      X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
      X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
      STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
      STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_PROD_WEBHOOK_SECRET }}
      STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_PUBLISHABLE_KEY }}
