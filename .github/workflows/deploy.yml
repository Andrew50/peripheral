name: Deploy to Kubernetes

on:
  # Deploy when pushing to stable branches
  push:
    branches:
      - dev
      - prod
  
  # Different trigger for pull requests with explicit configuration
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - dev
      - prod
  
  # Manual triggering
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy'
        required: true
        default: 'dev'

jobs:
  # Add a dependency on the lint-and-build workflow
  check-build:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Check if lint-and-build workflow passed
        run: |
          echo "This job ensures the lint-and-build workflow has passed before deployment"
          # This is a placeholder job that will be skipped for direct pushes
          # The actual dependency is handled by the workflow_run trigger

  deploy:
    runs-on: self-hosted  # Using self-hosted runner instead of ubuntu-latest
    needs: check-build
    if: github.event_name != 'pull_request' || success()
    
    steps:
      # Print debugging information before checkout
      - name: Debug Event Information
        run: |
          echo "Event name: ${{ github.event_name }}"
          echo "GitHub ref: ${{ github.ref }}"
          echo "GitHub head ref: ${{ github.head_ref }}"
          echo "GitHub base ref: ${{ github.base_ref }}"
          echo "GitHub ref name: ${{ github.ref_name }}"
          echo "Custom branch input: ${{ github.event.inputs.branch }}"

      # Determine which branch to checkout based on event type
      - name: Set checkout target
        id: set-target
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "CHECKOUT_REF=${{ github.head_ref }}" >> $GITHUB_ENV
            echo "TARGET_BRANCH=${{ github.base_ref }}" >> $GITHUB_ENV
            echo "Using PR source branch for checkout: ${{ github.head_ref }}"
            echo "Using PR target branch for Docker tags: ${{ github.base_ref }}"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.branch }}" ]; then
            echo "CHECKOUT_REF=${{ github.event.inputs.branch }}" >> $GITHUB_ENV
            echo "TARGET_BRANCH=${{ github.event.inputs.branch }}" >> $GITHUB_ENV
            echo "Using manual input branch: ${{ github.event.inputs.branch }}"
          else
            echo "CHECKOUT_REF=${{ github.ref_name }}" >> $GITHUB_ENV
            echo "TARGET_BRANCH=${{ github.ref_name }}" >> $GITHUB_ENV
            echo "Using current branch: ${{ github.ref_name }}"
          fi

      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: ${{ env.CHECKOUT_REF }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1
          lfs: false
      
      # Add diagnostic step to see what's available after checkout
      - name: Show Git Information
        run: |
          echo "Current directory: $(pwd)"
          echo "Directory contents: $(ls -la)"
          echo "Git status: $(git status)"
          echo "Current branch: $(git branch --show-current)"
          git --version
      
      # Verify secrets are available without exposing them
      - name: Verify Docker Credentials
        run: |
          echo "Docker username secret: $(if [ -n "${{ secrets.DOCKER_USERNAME }}" ]; then echo "is set"; else echo "is NOT set"; fi)"
          echo "Docker token secret: $(if [ -n "${{ secrets.DOCKER_TOKEN }}" ]; then echo "is set"; else echo "is NOT set"; fi)"
      
      # Copy the deployment script from the attached directory if it doesn't exist
      - name: Ensure deployment script exists
        run: |
          if [ ! -f "prod/deploy-prod.sh" ]; then
            echo "Deployment script not found in repository, creating prod directory..."
            mkdir -p prod
            
            # Create an error message with diagnostic information
            echo "ERROR: Could not find deployment script at prod/deploy-prod.sh"
            echo "Current directory contents:"
            ls -la
            echo "prod directory contents (if exists):"
            if [ -d "prod" ]; then
              ls -la prod/
            else
              echo "prod directory does not exist"
            fi
            
            # Exit with error
            exit 1
          else
            echo "Deployment script found at: $(pwd)/prod/deploy-prod.sh"
            chmod +x prod/deploy-prod.sh
            ls -la prod/
          fi
          
      # Deploy using GitHub secrets directly
      - name: Deploy to server
        env:
          DOCKER_USER: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_TOKEN: ${{ secrets.DOCKER_TOKEN }}
          GITHUB_REF_NAME: ${{ env.TARGET_BRANCH }}
        run: |
          # Debug environment (without revealing secrets)
          echo "Environment variables configured:"
          echo "DOCKER_USER: ${DOCKER_USER}"
          echo "DOCKER_TOKEN status: $(if [ -n "${DOCKER_TOKEN}" ]; then echo "is set"; else echo "is NOT set"; fi)"
          echo "GITHUB_REF_NAME: ${GITHUB_REF_NAME}"
          echo "GITHUB_ACTIONS: ${GITHUB_ACTIONS}"
          
          # Make script executable
          chmod +x prod/deploy-prod.sh
          
          # Run deployment script with GitHub secrets
          # Using TARGET_BRANCH for Docker image tags
          ./prod/deploy-prod.sh 