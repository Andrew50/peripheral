name: Deploy to Kubernetes (Staging)

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy'
        required: false
      force-deploy-db:
        description: 'Force Deploy DB'
        required: false
        default: false
        type: boolean      
      force-deploy-frontend:
        description: 'Force Deploy Frontend'
        required: false
        default: false
        type: boolean      
      force-deploy-backend:
        description: 'Force Deploy Backend'
        required: false
        default: false
        type: boolean      
      force-deploy-cache:
        description: 'Force Deploy Cache'
        required: false
        default: false
        type: boolean      
      force-deploy-worker:
        description: 'Force Deploy Worker'
        required: false
        default: false
        type: boolean      

permissions:
  contents: read
  packages: write
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  detect_changes:
    if: github.event_name == 'push'
    uses: ./.github/workflows/detect-changes.yml
  compute_manual_strategy:
    if: github.event_name == 'workflow_dispatch'
    outputs:
      strategy: ${{ steps.set-strategy.outputs.strategy }}
      services_changed: ${{ steps.set-strategy.outputs.services_changed }}
      skip_migrations: ${{ steps.set-strategy.outputs.skip_migrations }}    
    steps:
      - name: Set strategy from inputs
        id: set-strategy
        run: |
          SERVICES_CHANGED=""
          SKIP_MIGRATIONS=false
          if [ "${{ inputs.force-deploy-db }}" = "true" ]; then
            SERVICES_CHANGED="db $SERVICES_CHANGED"
            SKIP_MIGRATIONS=true
          fi
          if [ "${{ inputs.force-deploy-frontend }}" = "true" ]; then
            SERVICES_CHANGED="frontend $SERVICES_CHANGED"
          fi
          if [ "${{ inputs.force-deploy-backend }}" = "true" ]; then
            SERVICES_CHANGED="backend $SERVICES_CHANGED"
          fi
          if [ "${{ inputs.force-deploy-cache }}" = "true" ]; then
            SERVICES_CHANGED="cache $SERVICES_CHANGED"
          fi
          if [ "${{ inputs.force-deploy-worker }}" = "true" ]; then
            SERVICES_CHANGED="worker $SERVICES_CHANGED"
          fi
          echo "services_changed=$SERVICES_CHANGED" >> $GITHUB_OUTPUT
          echo "skip_migrations=$SKIP_MIGRATIONS" >> $GITHUB_OUTPUT
          echo "strategy=force deploy" >> $GITHUB_OUTPUT
  deploy-stage:
    needs: [detect_changes, compute_manual_strategy]
    if: |
      (github.event_name == 'push' && needs.detect_changes.outputs.strategy != 'no-changes') ||
      (github.event_name == 'workflow_dispatch' && needs.compute_manual_strategy.outputs.services_changed != '')
    uses: ./.github/workflows/deploy.yml
    with:
      environment: 'stage'
      target_branch: ${{ github.event.inputs.branch || github.ref_name }}
      k8s_namespace: 'stage'
      google_redirect_url: 'https://stage.peripheral.io/auth/google/callback'
      ingress_host: 'stage.peripheral.io'
      strategy: >-
        ${{ github.event_name == 'push' && needs.detect_changes.outputs.strategy || needs.compute_manual_strategy.outputs.strategy }}
      services_changed: >-
        ${{ github.event_name == 'push' && needs.detect_changes.outputs.services_changed || needs.compute_manual_strategy.outputs.services_changed }}      
      skip_migrations: ${{ needs.compute_manual_strategy.outputs.skip_migrations }}    
    secrets:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_TOKEN: ${{ secrets.DOCKER_TOKEN }}
      DB_ROOT_PASSWORD: ${{ secrets.STAGE_DB_ROOT_PASSWORD }}
      REDIS_PASSWORD: ${{ secrets.STAGE_REDIS_PASSWORD }}
      POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
      POLYGON_S3_KEY: ${{ secrets.POLYGON_S3_KEY }}
      POLYGON_S3_SECRET: ${{ secrets.POLYGON_S3_SECRET }}
      GEMINI_FREE_KEYS: ${{ secrets.GEMINI_FREE_KEYS }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
      GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
      JWT_SECRET: ${{ secrets.STAGE_JWT_SECRET }}
      CLOUDFLARE_TUNNEL_TOKEN: ${{ secrets.STAGE_CLOUDFLARE_TUNNEL_TOKEN }}
      TELEGRAM_BOT_TOKEN_B64: ${{ secrets.TELEGRAM_BOT_TOKEN_B64 }}
      TELEGRAM_CHAT_ID_B64: ${{ secrets.TELEGRAM_CHAT_ID_B64 }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
      TWITTER_API_IO_KEY: ${{ secrets.TWITTER_API_IO_KEY }}
      X_API_KEY: ${{ secrets.X_API_KEY }}
      X_API_SECRET: ${{ secrets.X_API_SECRET }}
      X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
      X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
      STRIPE_SECRET_KEY: ${{ secrets.STRIPE_DEV_SECRET_KEY }}
      STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_STAGE_WEBHOOK_SECRET }}
      STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_DEV_PUBLISHABLE_KEY }}
      TELEGRAM_USER_NOTIFICATION_BOT_TOKEN: ${{ secrets.TELEGRAM_USER_NOTIFICATION_BOT_TOKEN }}
      TELEGRAM_BEN_TWEETS_BOT_TOKEN: ${{ secrets.TELEGRAM_BEN_TWEETS_BOT_TOKEN }}
