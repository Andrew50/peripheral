# Stage 1: Build the SvelteKit app
FROM node:18-alpine AS builder
WORKDIR /app

# Copy package files first
COPY package*.json ./
# Replace npm ci with npm install to generate/update package-lock.json
RUN npm install

# Copy the entire app
COPY . .

# Build the app for production
RUN npm run build

# Stage 2: Run the production build
FROM node:18-alpine
WORKDIR /app

# Copy the built app from the builder stage
COPY --from=builder /app/build /app/build
COPY --from=builder /app/package*.json ./
COPY --from=builder /app/package-lock.json ./

# Now we can use npm ci since package-lock.json is in sync
RUN npm ci --omit=dev

# Create a custom server.js file to handle MIME types properly
RUN echo 'const { createServer } = require("http"); \
    const { handler } = require("./build/handler.js"); \
    const path = require("path"); \
    const server = createServer((req, res) => { \
    // Set proper MIME types for JavaScript modules \
    const url = req.url; \
    if (url.endsWith(".js")) { \
    res.setHeader("Content-Type", "application/javascript"); \
    } else if (url.endsWith(".mjs")) { \
    res.setHeader("Content-Type", "application/javascript"); \
    } else if (url.endsWith(".css")) { \
    res.setHeader("Content-Type", "text/css"); \
    } else if (url.includes("/_app/immutable/") || url.includes("/_app/")) { \
    const ext = path.extname(url); \
    if (ext === ".js" || ext === ".mjs" || ext === "") { \
    res.setHeader("Content-Type", "application/javascript"); \
    } else if (ext === ".css") { \
    res.setHeader("Content-Type", "text/css"); \
    } \
    } \
    return handler(req, res); \
    }); \
    server.listen(3000, () => { \
    console.log("Listening on port 3000"); \
    });' > server.js

# Expose the port
EXPOSE 3000

# Start the app with our custom server
CMD ["node", "server.js"]

