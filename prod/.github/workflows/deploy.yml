name: Deploy to Kubernetes

on:
  push:
    branches:
      - prod-beta  # Deploy when pushing to the prod-beta branch
  workflow_dispatch:  # Allow manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Install Cloudflared
        run: |
          # Download and install cloudflared
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared.deb
          
      - name: Set up SSH key
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
          
      - name: Configure SSH for Cloudflare Access
        env:
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
        run: |
          # Create SSH config directory
          mkdir -p ~/.ssh
          
          # Configure SSH to use Cloudflare Access for SSH connections
          cat > ~/.ssh/config << EOL
          Host ${REMOTE_HOST}
            ProxyCommand cloudflared access ssh --hostname %h
            User ${REMOTE_USER}
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
          EOL
          
          chmod 600 ~/.ssh/config
          
      - name: Deploy to server
        env:
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          DOCKER_USER: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_TOKEN: ${{ secrets.DOCKER_TOKEN }}
          CLOUDFLARE_TEAM: ${{ secrets.CLOUDFLARE_TEAM }}
          CLOUDFLARE_CERT: ${{ secrets.CLOUDFLARE_CERT }}
        run: |
          # Setup Cloudflare certificate if provided
          if [ ! -z "$CLOUDFLARE_CERT" ]; then
            mkdir -p ~/.cloudflared
            echo "$CLOUDFLARE_CERT" > ~/.cloudflared/cert.pem
          fi
          
          # Replace placeholders in the deploy script
          sed -i "s/ssh.atlantis.trading/${REMOTE_HOST}/g" prod/deploy-prod.sh
          sed -i "s/\"aj\"/${REMOTE_USER}/g" prod/deploy-prod.sh
          sed -i "s/billin19/${DOCKER_USER}/g" prod/deploy-prod.sh
          
          # Make script executable
          chmod +x prod/deploy-prod.sh
          
          # Run deployment script
          ./prod/deploy-prod.sh 