# TimescaleDB Core Configuration
shared_preload_libraries = 'timescaledb'
timescaledb.max_background_workers = 4  # Reduced from 8
timescaledb.telemetry_level = 'off'

# Memory Settings - REDUCED for stability
work_mem = 256MB                    # Reduced from 1GB - critical for stability
maintenance_work_mem = 512MB        # Reduced from 2GB
shared_buffers = 2GB                # Reduced from 8GB
effective_cache_size = 6GB          # Reduced from 24GB
wal_buffers = 64MB                  # Reduced from 256MB

# Worker Processes - REDUCED to prevent resource exhaustion
max_worker_processes = 16           # Reduced from 32
max_parallel_workers = 4            # Reduced from 16 - CRITICAL
max_parallel_workers_per_gather = 2 # Reduced from 8 - CRITICAL
max_parallel_maintenance_workers = 2 # Added limit

# Connection Settings
max_connections = 100               # Reduced from 200
listen_addresses = '*'

# WAL and Checkpoint Settings
max_wal_size = 4GB                  # Reduced from 16GB
min_wal_size = 1GB                  # Reduced from 4GB
checkpoint_timeout = '15min'        # Reduced from 30min for more frequent checkpoints
checkpoint_completion_target = 0.9
synchronous_commit = 'on'           # Changed from 'off' for data safety

# Query Execution - CRITICAL LIMITS FOR DEADLOCK PREVENTION
statement_timeout = '30min'         # Reduced from 120min
lock_timeout = '5min'               # FIXED: Reduced from 10min for faster deadlock detection
idle_in_transaction_session_timeout = '10min'  # FIXED: Reduced from 30min to clear idle transactions faster
max_locks_per_transaction = 512     # FIXED: Increased from 256 to handle truncate and large batches
deadlock_timeout = '1s'             # FIXED: Added for faster deadlock detection
random_page_cost = 1.1

# CRITICAL: Resource Control
temp_file_limit = '2GB'             # Added limit on temp files
log_temp_files = 100MB              # Log large temp files
max_stack_depth = '2MB'             # Reduced stack depth

# Autovacuum Settings - OPTIMIZED for OHLCV workload
autovacuum = on
autovacuum_max_workers = 3          # Reduced from 6
autovacuum_naptime = '2min'         # FIXED: Reduced from 5min for more frequent cleanup
autovacuum_vacuum_threshold = 1000  # FIXED: Increased from 500 for OHLCV tables
autovacuum_analyze_threshold = 500  # FIXED: Increased from 250 for OHLCV tables
autovacuum_vacuum_scale_factor = 0.05 # FIXED: Reduced from 0.1 for frequent cleanup
autovacuum_analyze_scale_factor = 0.02 # FIXED: Reduced from 0.05 for better stats

# TimescaleDB Query Optimization - OPTIMIZED for batch inserts
timescaledb.max_open_chunks_per_insert = 200  # FIXED: Reduced from 500 to prevent lock contention
timescaledb.enable_optimizations = on         # FIXED: Added for better performance
timescaledb.enable_constraint_exclusion = on  # FIXED: Added for partition pruning
enable_partitionwise_aggregate = on
jit = off                           # DISABLED - can cause crashes on complex queries

# Logging and Monitoring - ENHANCED for debugging
# log_min_duration_statement = 5000   # Log queries longer than 5 seconds
log_line_prefix = '%t [%p-%l] %q%u@%d '
# log_checkpoints = on
# log_connections = on
# log_disconnections = on
# log_lock_waits = on                 # CRITICAL: Log lock waits for debugging
# log_temp_files = 100MB
# log_autovacuum_min_duration = 0
log_statement_stats = off           # FIXED: Disabled for performance
log_duration = off                  # FIXED: Disabled for performance

# Advanced Optimizations - TUNED for OHLCV workload
vacuum_cost_delay = 5ms             # FIXED: Reduced from 10ms for faster vacuum
vacuum_cost_limit = 2000            # FIXED: Increased from 1000 for better vacuum performance
bgwriter_delay = 200ms              # Increased from 20ms
bgwriter_lru_maxpages = 500         # Reduced from 1000
bgwriter_flush_after = 512kB        # FIXED: Added to improve I/O patterns
track_io_timing = on
default_statistics_target = 100     # Reduced from 500

# CRITICAL: Prevent OOM conditions
huge_pages = off                    # Disable huge pages which can cause issues
shared_memory_type = mmap           # Use mmap for better memory management

# CRITICAL: Query Planning Limits
from_collapse_limit = 8             # Default, but explicit
join_collapse_limit = 8             # Default, but explicit
max_pred_locks_per_transaction = 64 # Default, but explicit
max_pred_locks_per_relation = 64    # Default, but explicit

# FIXED: Additional settings for batch insert optimization
wal_compression = on                # Compress WAL for better I/O
wal_init_zero = off                 # Don't zero-fill WAL files for performance
wal_recycle = on                    # Recycle WAL files
checkpoint_flush_after = 256kB      # Flush more frequently during checkpoints

# FIXED: Connection pooling optimization
tcp_keepalives_idle = 600           # 10 minutes
tcp_keepalives_interval = 30        # 30 seconds
tcp_keepalives_count = 3            # 3 attempts
