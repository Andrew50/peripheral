#dev.conf
#assume 4 cpus, 8gb ram, 160gb disk, as sepcified in docker-compose.yaml

# TimescaleDB Core Configuration
shared_preload_libraries = 'timescaledb,pg_stat_statements'
timescaledb.max_background_workers = 8  # FIXED: Increased to handle all background jobs
timescaledb.telemetry_level = 'off'

# CRITICAL: Network Configuration for Docker
listen_addresses = '*'                  # Listen on all interfaces for container networking **CRITICAL: DO NOT REMOVE THIS**

# CRITICAL: Data Integrity & Corruption Prevention
#data_checksums = on # handled by docker image becuase requires initdb
full_page_writes = on                  # Ensure WAL contains complete pages after checkpoints
fsync = on                              # Ensure data integrity
synchronous_commit = on                 # Wait for WAL writes

# MEMORY SETTINGS - OPTIMIZED FOR 8GB RAM (SCREENER PERFORMANCE TUNED)
shared_buffers = 2GB                   # FIXED: 25% of RAM for dev
work_mem = 1GB                         # INCREASED: Critical for screener aggregations - keep large datasets in memory
maintenance_work_mem = 1GB             # INCREASED: Critical for large index creation on hypertables
effective_cache_size = 5GB             # FIXED: 62% of RAM for dev
wal_buffers = 96MB                     # FIXED: Balanced for dev

# CONNECTIONS & PARALLELISM - OPTIMIZED FOR 4 vCPUs (SCREENER PERFORMANCE TUNED)
max_connections = 75                   # FIXED: Balanced for dev
max_worker_processes = 16              # INCREASED: Better for screener parallel operations
max_parallel_workers = 4               # INCREASED: Use all 4 cores for parallel operations
max_parallel_workers_per_gather = 4    # INCREASED: Critical for screener parallel aggregations
max_parallel_maintenance_workers = 3   # INCREASED: Better for index creation

# WAL & CHECKPOINT SETTINGS - OPTIMIZED FOR 160GB DISK
max_wal_size = 4GB                     # FIXED: Reduced for dev
min_wal_size = 1GB                     # FIXED: Reduced for dev
checkpoint_timeout = '10min'           # Keep existing
checkpoint_completion_target = 0.9     # Keep existing (single instance)
wal_keep_size = '256MB'                # FIXED: Reduced for dev
wal_level = replica                    # Keep existing
archive_mode = off                     # DISABLED for development - no backup directory
# archive_command = 'test ! -f /backups/archive/%f && cp %p /backups/archive/%f'

# LOGGING ESSENTIALS - DEVELOPMENT OPTIMIZED
# DISABLED logging_collector to ensure logs go to stdout/stderr for kubectl/docker logs
logging_collector = off                # Logs go to stdout/stderr for container logging
log_line_prefix = '%m [%p] %u@%d %i %e '  # FIXED: Improved prefix format
log_min_duration_statement = 500       # Log queries > 500ms (lower threshold for dev)
log_statement = 'none'                 # Disable statement-level logging (quiet noisy console output)
log_checkpoints = on                   # Log checkpoint activity
log_lock_waits = on                    # Log lock waits for deadlock detection
log_temp_files = 0                     # Log ALL temp file usage
log_error_verbosity = verbose          # FIXED: More verbose for better debugging
log_min_messages = warning             # FIXED: Log warnings and above
track_io_timing = on                   # Measure I/O timing
track_functions = all                  # FIXED: Added for PL/pgSQL profiling
track_activity_query_size = 2048       # FIXED: Reduced for dev

# AUTO_EXPLAIN - REMOVED (extension not available in TimescaleDB image)

# PG_STAT_STATEMENTS CONFIGURATION
pg_stat_statements.track = all
pg_stat_statements.track_utility = on
pg_stat_statements.max = 5000          # FIXED: Reduced for dev

# TIMESCALEDB DEBUGGING
timescaledb.bgw_log_level = 'DEBUG1'   # Verbose background worker logs

# TIMESCALEDB PERFORMANCE OPTIMIZATIONS (DEV SCALED)
timescaledb.enable_chunkwise_aggregation = on
timescaledb.vectorized_aggregation = on  # Keep if TimescaleDB >= 2.13
timescaledb.enable_merge_on_cagg_refresh = on
timescaledb.max_open_chunks_per_insert = 256   # Adjusted compromise to avoid cache mismatch
timescaledb.max_cached_chunks_per_hypertable = 1024  # FIXED: Increased to exceed insert cache size and remove warnings
timescaledb.enable_optimizations = on
timescaledb.enable_constraint_exclusion = on
timescaledb.enable_chunk_append = on
timescaledb.enable_ordered_append = on
timescaledb.enable_parallel_chunk_append = on   # ENABLED: Better for index creation on large hypertables
timescaledb.enable_runtime_exclusion = on
timescaledb.enable_transparent_decompression = on
timescaledb.max_tuples_decompressed_per_dml_transaction = 500000  # INCREASED: Better for large operations
timescaledb.max_insert_batch_size = 5000  # INCREASED: Better for bulk operations

# CRITICAL: Connection & Query Limits
idle_in_transaction_session_timeout = '10min'
lock_timeout = '5min'
deadlock_timeout = '1s'                # Single instance

# CRITICAL: Resource Protection
temp_file_limit = '4GB'                # INCREASED: Allow large CA refreshes (was 1GB)
max_stack_depth = '4MB'                # FIXED: Increased from 2MB for deep recursions

# AUTOVACUUM OPTIMIZATION FOR TIMESERIES (DEV SCALED)
autovacuum = on
autovacuum_max_workers = 2             # FIXED: Balanced for dev
autovacuum_naptime = '2min'            # Keep existing
autovacuum_vacuum_threshold = 1000     # Keep existing
autovacuum_analyze_threshold = 500     # Keep existing
autovacuum_vacuum_scale_factor = 0.1   # Keep existing
autovacuum_analyze_scale_factor = 0.05 # Keep existing
autovacuum_vacuum_cost_limit = 1200    # FIXED: Balanced for dev
autovacuum_vacuum_cost_delay = 4ms     # FIXED: Balanced for dev

# TIMESCALEDB QUERY OPTIMIZATION (DEV SCALED)
enable_partitionwise_aggregate = on
jit = off                              # DISABLED - can cause crashes on complex queries

# ADVANCED OPTIMIZATIONS (DEV SCALED)
vacuum_cost_delay = 10ms               # FIXED: Increased for dev
vacuum_cost_limit = 1000               # FIXED: Reduced for dev
bgwriter_delay = 200ms                 # Keep existing
bgwriter_lru_maxpages = 250            # FIXED: Reduced for dev
bgwriter_flush_after = 256kB           # Keep existing
default_statistics_target = 100        # Keep existing

# CRITICAL: Prevent OOM conditions
huge_pages = off                       # Disable huge pages which can cause issues
shared_memory_type = mmap              # Use mmap for better memory management

# CRITICAL: Query Planning Limits
from_collapse_limit = 8                # Default, but explicit
join_collapse_limit = 8                # Default, but explicit
max_pred_locks_per_transaction = 64    # Default, but explicit
max_pred_locks_per_relation = 64       # Default, but explicit
max_locks_per_transaction = 512        # Default, but explicit

# WAL OPTIMIZATION (DEV SCALED)
wal_compression = on                   # Compress WAL for better I/O
wal_init_zero = off                    # Don't zero-fill WAL files for performance
wal_recycle = on                       # Recycle WAL files
checkpoint_flush_after = 256kB         # Flush more frequently during checkpoints

# CONNECTION POOLING OPTIMIZATION
tcp_keepalives_idle = 600              # 10 minutes
tcp_keepalives_interval = 30           # 30 seconds
tcp_keepalives_count = 3               # 3 attempts

# I/O OPTIMIZATION (DEV SCALED)
effective_io_concurrency = 200         # INCREASED: Better for index creation
maintenance_io_concurrency = 200       # INCREASED: Better for index creation

# TIMESCALEDB OPTIMIZATIONS
random_page_cost = 1.1

# REMOVED INVALID/REDUNDANT PARAMETERS:
# - log_autovacuum (invalid GUC)
# - log_wal_info (invalid GUC)
# - Duplicate wal_buffers, checkpoint_completion_target, deadlock_timeout
# - log_duration, log_executor_stats, log_planner_stats, log_parser_stats (high overhead)
# - commit_delay, commit_siblings (negligible benefit on SSD)
