# TimescaleDB Core Configuration
shared_preload_libraries = 'timescaledb'
timescaledb.max_background_workers = 4  # Reduced from 8
timescaledb.telemetry_level = 'off'

# Memory Settings - REDUCED for stability
work_mem = 256MB                    # Reduced from 1GB - critical for stability
maintenance_work_mem = 512MB        # Reduced from 2GB
shared_buffers = 2GB                # Reduced from 8GB
effective_cache_size = 6GB          # Reduced from 24GB
wal_buffers = 64MB                  # Reduced from 256MB

# Worker Processes - REDUCED to prevent resource exhaustion
max_worker_processes = 16           # Reduced from 32
max_parallel_workers = 4            # Reduced from 16 - CRITICAL
max_parallel_workers_per_gather = 2 # Reduced from 8 - CRITICAL
max_parallel_maintenance_workers = 2 # Added limit

# Connection Settings
max_connections = 100               # Reduced from 200
listen_addresses = '*'

# WAL and Checkpoint Settings
max_wal_size = 4GB                  # Reduced from 16GB
min_wal_size = 1GB                  # Reduced from 4GB
checkpoint_timeout = '15min'        # Reduced from 30min for more frequent checkpoints
checkpoint_completion_target = 0.9
synchronous_commit = 'on'           # Changed from 'off' for data safety

# Query Execution - ADDED CRITICAL LIMITS
statement_timeout = '30min'         # Reduced from 120min
lock_timeout = '10min'              # Added timeout for lock waits
idle_in_transaction_session_timeout = '30min'  # Added session timeout
max_locks_per_transaction = 128     # Reduced from 256
random_page_cost = 1.1

# CRITICAL: Resource Control
temp_file_limit = '2GB'             # Added limit on temp files
log_temp_files = 100MB              # Log large temp files
max_stack_depth = '2MB'             # Reduced stack depth

# Autovacuum Settings
autovacuum = on
autovacuum_max_workers = 3          # Reduced from 6
autovacuum_naptime = '5min'         # Reduced from 10min
autovacuum_vacuum_threshold = 500   # Reduced from 1000
autovacuum_analyze_threshold = 250  # Reduced from 500
autovacuum_vacuum_scale_factor = 0.1 # Increased from 0.05
autovacuum_analyze_scale_factor = 0.05 # Increased from 0.025

# TimescaleDB Query Optimization
timescaledb.max_open_chunks_per_insert = 500  # Reduced from 1000
enable_partitionwise_aggregate = on
jit = off                           # DISABLED - can cause crashes on complex queries
# jit_above_cost = 100000           # Disabled with JIT
# jit_inline_above_cost = 150000    # Disabled with JIT  
# jit_optimize_above_cost = 350000  # Disabled with JIT

# Logging and Monitoring - ENHANCED
log_min_duration_statement = 5000   # Log queries longer than 5 seconds
log_line_prefix = '%t [%p-%l] %q%u@%d '
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_temp_files = 100MB
log_autovacuum_min_duration = 0

# Advanced Optimizations
vacuum_cost_delay = 10ms            # Increased from 2ms to reduce I/O pressure
vacuum_cost_limit = 1000            # Reduced from 2000
bgwriter_delay = 200ms              # Increased from 20ms
bgwriter_lru_maxpages = 500         # Reduced from 1000
track_io_timing = on
default_statistics_target = 100     # Reduced from 500

# CRITICAL: Prevent OOM conditions
huge_pages = off                    # Disable huge pages which can cause issues
shared_memory_type = mmap           # Use mmap for better memory management

# CRITICAL: Query Planning Limits
from_collapse_limit = 8             # Default, but explicit
join_collapse_limit = 8             # Default, but explicit
max_pred_locks_per_transaction = 64 # Default, but explicit
max_pred_locks_per_relation = 64    # Default, but explicit
