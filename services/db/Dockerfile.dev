FROM timescale/timescaledb-ha:pg17
USER root
# Password will be provided via environment variables
RUN apt-get update && apt-get install -y cron

# Environment variables to control PostgreSQL initialization
ENV PGDATA /var/lib/postgresql/data

# Create an SQL init directory that will be processed after PostgreSQL initializes
EXPOSE 5432
COPY init.sql /docker-entrypoint-initdb.d/init.sql
COPY securities.csv /docker-entrypoint-initdb.d/securities.csv
COPY samples.csv /docker-entrypoint-initdb.d/samples.csv

# Copy the PostgreSQL configuration
COPY dev.conf /etc/postgresql/postgresql.conf

# Copy the migrations script
COPY run_migrations.sh /app/run_migrations.sh
RUN chmod +x /app/run_migrations.sh

# Copy the watch script
COPY watch_rollouts.sh /app/watch_rollouts.sh
RUN chmod +x /app/watch_rollouts.sh

# Create rollouts directory with proper permissions
RUN mkdir -p /tmp/rollouts && chmod 777 /tmp/rollouts

# Copy our custom entrypoint script
COPY start.sh /app/start.sh
RUN chmod +x /app/start.sh

# Start PostgreSQL using our custom entrypoint
ENTRYPOINT ["/app/start.sh"]
